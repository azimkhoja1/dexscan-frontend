<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DexScan ‚Äî Bitget Bot</title>
  <style>
    body {
      background-color: #0d1117;
      color: #e6edf3;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #161b22;
      padding: 10px 20px;
      border-bottom: 1px solid #30363d;
    }
    header span {
      font-weight: bold;
      color: #58a6ff;
    }
    .controls, .scanner, .trades {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin: 10px;
      padding: 15px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 2fr 2fr;
      gap: 10px;
    }
    button {
      background: #238636;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 6px;
    }
    button.red { background: #d73a49; }
    button.blue { background: #1f6feb; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #30363d;
      text-align: left;
    }
    .mode-label {
      font-size: 13px;
      color: #aaa;
    }
    .top-coins {
      display: flex;
      gap: 20px;
      font-size: 14px;
    }
    .top-coins span { color: #7ee787; }
  </style>
</head>
<body>
  <header>
    <div>
      <span>DexScan ‚Äî Bitget Bot</span>
      <div class="top-coins">
        <span>BTC: <b id="btcPrice">--</b></span>
        <span>ETH: <b id="ethPrice">--</b></span>
        <span>BNB: <b id="bnbPrice">--</b></span>
      </div>
    </div>
    <div>
      <b id="modeStatus" style="color:#ffa657;">Loading mode...</b>
    </div>
  </header>

  <div class="grid">
    <div class="controls">
      <h3>Controls</h3>
      <button id="deepScanBtn">üîç Deep Scan</button>
      <button id="autoScanBtn" class="blue">Auto: OFF</button>
      <button id="toggleModeBtn">Switch to Live</button>
      <button id="refreshBtn" class="blue">Refresh</button>
      <div id="logBox" style="margin-top:10px; font-size:12px; max-height:200px; overflow:auto;"></div>
    </div>

    <div class="scanner">
      <h3>Scanner Results</h3>
      <table>
        <thead>
          <tr><th>Symbol</th><th>Score</th><th>Entry</th><th>Reason</th><th>Actions</th></tr>
        </thead>
        <tbody id="scanResults"></tbody>
      </table>
    </div>

    <div class="trades">
      <h3>Trades & Wallet</h3>
      <div>Balance: <b id="balance">--</b> USDT</div>
      <table>
        <thead><tr><th>Symbol</th><th>Entry</th><th>PNL</th><th>Status</th></tr></thead>
        <tbody id="tradesList"></tbody>
      </table>
    </div>
  </div>

  <script>
    const BACKEND = "https://dexscan-backend.onrender.com";
    const logBox = document.getElementById("logBox");
    const addLog = msg => {
      const t = new Date().toLocaleTimeString();
      logBox.innerHTML = `[${t}] ${msg}<br>` + logBox.innerHTML;
    };

    async function loadPrices() {
      try {
        const r = await fetch(BACKEND + "/api/header");
        const d = await r.json();
        document.getElementById("btcPrice").textContent = d.find(x => x.id==="bitcoin") ? "OK" : "--";
      } catch { addLog("Failed to load prices"); }
    }

    async function refreshPrices() {
      try {
        const url = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin&vs_currencies=usd";
        const res = await fetch(url);
        const data = await res.json();
        document.getElementById("btcPrice").textContent = data.bitcoin.usd;
        document.getElementById("ethPrice").textContent = data.ethereum.usd;
        document.getElementById("bnbPrice").textContent = data.binancecoin.usd;
      } catch {}
    }

    async function loadMode() {
      const res = await fetch(BACKEND + "/api/mode");
      const d = await res.json();
      const modeLabel = document.getElementById("modeStatus");
      const toggleBtn = document.getElementById("toggleModeBtn");
      if (d.demo) {
        modeLabel.textContent = "üß™ Demo Mode";
        modeLabel.style.color = "#7ee787";
        toggleBtn.textContent = "Switch to Live";
      } else {
        modeLabel.textContent = "üíπ Live Mode";
        modeLabel.style.color = "#ffa657";
        toggleBtn.textContent = "Switch to Demo";
      }
    }

    async function toggleMode() {
      const res = await fetch(BACKEND + "/api/mode");
      const d = await res.json();
      const newMode = !d.demo;
      await fetch(BACKEND + "/api/mode", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ demo: newMode })
      });
      addLog("Mode switched to " + (newMode ? "Demo" : "Live"));
      await loadMode();
    }

    async function runScan() {
      addLog("Triggering deep scan...");
      const res = await fetch(BACKEND + "/api/scan/run", { method: "POST" });
      const data = await res.json();
      const box = document.getElementById("scanResults");
      box.innerHTML = "";
      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.symbol}</td>
          <td>${c.score}</td>
          <td>${c.entry}</td>
          <td title="${c.reasons.join(', ')}">${c.reasons.join(', ')}</td>
          <td>
            <button onclick="buy('${c.symbol}')">Buy</button>
          </td>
        `;
        box.appendChild(tr);
      });
      addLog(`Scan finished: ${data.length} results`);
    }

    async function buy(symbol) {
      const res = await fetch(BACKEND + "/api/trade/buy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol })
      });
      const data = await res.json();
      addLog(`Buy executed: ${symbol}`);
      await loadTrades();
      await loadBalance();
    }

    async function sell(id) {
      const res = await fetch(BACKEND + "/api/trade/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      addLog(`Sell executed: ${data.trade.symbol}`);
      await loadTrades();
      await loadBalance();
    }

    async function loadTrades() {
      const res = await fetch(BACKEND + "/api/trades");
      const data = await res.json();
      const list = document.getElementById("tradesList");
      list.innerHTML = "";
      data.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.symbol}</td>
          <td>${t.entry_price?.toFixed(4) || "-"}</td>
          <td>${t.pnl?.toFixed(3) || 0}</td>
          <td>${t.status}</td>
          <td><button class="red" onclick="sell(${t.id})">Sell</button></td>
        `;
        list.appendChild(tr);
      });
    }

    async function loadBalance() {
      const res = await fetch(BACKEND + "/api/balance");
      const data = await res.json();
      document.getElementById("balance").textContent = data.balance.USDT.toFixed(2);
    }

    document.getElementById("deepScanBtn").onclick = runScan;
    document.getElementById("refreshBtn").onclick = () => { loadTrades(); loadBalance(); refreshPrices(); };
    document.getElementById("toggleModeBtn").onclick = toggleMode;

    setInterval(refreshPrices, 15000);
    setInterval(loadTrades, 10000);
    loadMode();
    refreshPrices();
    loadBalance();
    loadTrades();
  </script>
</body>
</html>
