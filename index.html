<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>DexScan V3 Frontend</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#071226;color:#e6f0f0;}
header{background:#081424;padding:10px;display:flex;justify-content:space-between;align-items:center;}
.card{background:#0f2430;margin:10px;padding:10px;border-radius:8px;}
button{padding:6px 10px;margin:3px;border:none;border-radius:6px;cursor:pointer;color:white}
.btn{background:#00b894}
.btn.gray{background:#3a3a3a}
.btn.red{background:#e74c3c}
table{width:100%;border-collapse:collapse;margin-top:5px}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
th{color:#9fb0b9}
#log{font-size:12px;max-height:150px;overflow:auto;background:#091a25;padding:5px;margin-top:5px;border-radius:6px}
</style>
</head>
<body>
<header>
  <div><b>DexScan V3</b> ‚Äî BTC <span id="btc">-</span> | ETH <span id="eth">-</span> | BNB <span id="bnb">-</span></div>
  <div>Mode: <span id="modeTxt">-</span></div>
</header>

<div class="card">
  <button id="deepScan" class="btn">üîç Deep Scan</button>
  <button id="autoBtn" class="btn gray">Auto: OFF</button>
  <button id="refresh" class="btn gray">Refresh</button>
</div>

<div class="card">
  <h3>Scanner</h3>
  <table><thead><tr><th>Symbol</th><th>Score</th><th>Entry</th><th>Reasons</th><th></th></tr></thead>
  <tbody id="scanBody"></tbody></table>
</div>

<div class="card">
  <h3>Trades</h3>
  Balance: <b id="bal">-</b>
  <table><thead><tr><th>Symbol</th><th>Entry</th><th>Latest</th><th>PNL</th><th>Status</th><th></th></tr></thead>
  <tbody id="tradesBody"></tbody></table>
</div>

<div class="card"><div id="log"></div></div>

<script>
const API="https://dexscan-backend.onrender.com/api";
const logBox=document.getElementById("log");
const L=msg=>logBox.innerHTML=new Date().toLocaleTimeString()+" ‚Äî "+msg+"<br>"+logBox.innerHTML;
async function get(p){try{const r=await fetch(API+p);return await r.json();}catch{return null;}}
async function post(p,d){try{const r=await fetch(API+p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});return await r.json();}catch{return null;}}

async function loadHeader(){
  const r=await get("/header");
  if(!r)return;
  for(const t of r){const id=t.symbol.slice(0,3).toLowerCase();document.getElementById(id).textContent=t.price.toFixed(2);}
}
async function loadBalance(){const b=await get("/balance");if(b)document.getElementById("bal").innerText=(b.balance.USDT||0).toFixed(2);}
async function scan(){
  L("Scanning...");
  const d=await post("/scan/run");
  const tb=document.getElementById("scanBody");tb.innerHTML="";
  d.forEach(c=>tb.innerHTML+=`<tr><td>${c.symbol}</td><td>${c.score}</td><td>${c.entry.toFixed(4)}</td><td>${(c.reasons||[]).join(', ')}</td><td><button class='btn' onclick="buy('${c.symbol}')">Buy</button></td></tr>`);
}
async function buy(sym){await post("/trade/buy",{symbol:sym});L("Buy "+sym);loadTrades();loadBalance();}
async function sell(id){await post("/trade/sell",{trade_id:id});L("Sell "+id);loadTrades();loadBalance();}
async function loadTrades(){
  const d=await get("/trades");if(!d)return;
  const tb=document.getElementById("tradesBody");tb.innerHTML="";
  d.forEach(t=>{
    const pnl=(t.unreal_pnl||t.pnl||0).toFixed(3);
    tb.innerHTML+=`<tr><td>${t.symbol}</td><td>${t.entry_price?.toFixed(3)||"-"}</td><td>${t.latest_price?.toFixed(3)||"-"}</td><td style="color:${pnl>=0?'#00e676':'#ff5252'}">${pnl}</td><td>${t.status}</td><td>${t.status==='OPEN'?'<button class="btn red" onclick="sell('+t.id+')">Sell</button>':'-'}</td></tr>`;
  });
}

async function toggleAuto(){
  const r=await get("/auto");
  const next=!r.auto;
  await post("/auto",{enabled:next});
  document.getElementById("autoBtn").innerText=next?"Auto: ON":"Auto: OFF";
  if(next)L("Auto scan ON");
}
document.getElementById("deepScan").onclick=scan;
document.getElementById("autoBtn").onclick=toggleAuto;
document.getElementById("refresh").onclick=()=>{loadHeader();loadBalance();loadTrades();};

(async ()=>{
  loadHeader();loadBalance();loadTrades();
  const auto=await get("/auto");
  if(auto?.auto){L("Auto ON ‚Üí auto scan running");await scan();}
  setInterval(loadHeader,5000);
  setInterval(loadTrades,5000);
  setInterval(loadBalance,7000);
})();
</script>
</body>
</html>
