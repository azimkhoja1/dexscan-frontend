<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>DexScan ‚Äî Bitget Dashboard (live BTC/ETH/BNB)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{background:#071020;color:#e6f0f0;font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#071526;border-radius:8px}
    h1{margin:0;font-size:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card{background:#0e1720;padding:12px;border-radius:8px;flex:1;min-width:260px}
    button{background:#2a9d8f;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .green{color:#4ade80}.red{color:#fb7185}
    .small{font-size:13px;color:#9fb0b9}
    #logs{max-height:220px;overflow:auto;background:#071526;padding:8px;border-radius:6px}
    .muted{color:#7b8b95;font-size:13px}
    .btn-small{padding:6px 8px;border-radius:6px;font-size:13px}
    .indicator-list{font-size:12px;color:#cfe8e0}
    a.symbol-link{color:#8fe7d1;text-decoration:none;cursor:pointer}
    a.symbol-link:hover{text-decoration:underline}
    .buy-btn{background:#117a65}
    .close-btn{background:#b02a37}
    .live-row{display:flex;gap:12px;align-items:center}
    .live-price{font-weight:600;font-size:18px;margin-left:8px}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <h1>üíπ DexScan ‚Äî Bitget Dashboard</h1>
      <div class="live-row">
        <span class="small">BTC</span><span id="btcPrice" class="live-price">‚Äî</span>
        <span class="small">ETH</span><span id="ethPrice" class="live-price">‚Äî</span>
        <span class="small">BNB</span><span id="bnbPrice" class="live-price">‚Äî</span>
      </div>
    </div>
    <div id="status" class="small">Connecting...</div>
  </header>

  <div class="row">
    <div class="card" style="max-width:360px">
      <h3>Controls</h3>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="deepScan">üîç Deep Scan</button>
        <button id="toggleAuto" class="btn-small">‚è± Auto: OFF</button>
        <button id="refreshAll" class="btn-small">üîÑ Refresh</button>
      </div>
      <div class="info small" style="margin-top:8px">Demo mode: controlled by backend env <code>BITGET_DEMO</code>. Set BITGET_DEMO=0 for live trading (use caution).</div>
      <div id="logs" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Scanner Results (up to 10 active signals)</h3>
      <table id="scan">
        <thead><tr><th>Symbol</th><th>Score</th><th>Entry</th><th>TP</th><th>Reason</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Trades & Wallet</h3>
      <div id="balance" class="small">Balance: ...</div>
      <div style="margin-top:8px">
        <button id="showTrades">Show Trades</button>
      </div>
      <div id="tradelist" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#07121a;padding:16px;border-radius:8px;box-shadow:0 6px 30px rgba(0,0,0,0.6);min-width:380px;z-index:9999">
    <div id="modalContent"></div>
    <div style="text-align:right;margin-top:8px"><button id="closeModal">Close</button></div>
  </div>

<script>
const API_BASE = "https://dexscan-backend.onrender.com/api";
let wsSockets = {};

// log helper
function log(msg){
  const node = document.getElementById("logs");
  node.innerHTML = new Date().toLocaleTimeString() + " ‚Äî " + msg + "<br>" + node.innerHTML;
  console.log(msg);
}

// safeFetch
async function safeFetch(url, opts = {}) {
  try {
    const r = await fetch(url, opts);
    if (!r.ok) {
      const txt = await r.text();
      log(`HTTP ${r.status} ${url} ‚Äî ${txt}`);
      return { ok:false, status: r.status, text: txt };
    }
    const j = await r.json();
    return { ok:true, data: j };
  } catch (e) {
    log("Fetch error: " + e.message);
    return { ok:false, error: e.message };
  }
}

// ===== Live websocket for BTC/ETH/BNB prices (frontend direct) =====
function startWsPair(symbol, domId) {
  try {
    const pair = symbol.toLowerCase();
    const socket = new WebSocket(`wss://stream.binance.com:9443/ws/${pair}@trade`);
    socket.onmessage = (ev) => {
      try {
        const d = JSON.parse(ev.data);
        const price = Number(d.p);
        document.getElementById(domId).innerText = price ? price.toLocaleString() : "-";
      } catch(e){}
    };
    socket.onopen = () => console.log("WS open", symbol);
    socket.onerror = (e) => console.warn("WS error", symbol, e);
    wsSockets[symbol] = socket;
  } catch(e) { console.warn("startWsPair error", e); }
}
startWsPair("BTCUSDT","btcPrice");
startWsPair("ETHUSDT","ethPrice");
startWsPair("BNBUSDT","bnbPrice");

// update status when backend reachable
async function updateStatus() {
  const r = await safeFetch(API_BASE + "/");
  const st = document.getElementById("status");
  if (r.ok) st.innerText = "Connected";
  else st.innerText = "Backend not reachable";
}

// load scan results
async function loadScan(){
  const r = await safeFetch(API_BASE + "/scan/results");
  if (!r.ok) {
    document.querySelector("#scan tbody").innerHTML = "<tr><td colspan='6'>No results</td></tr>";
    return;
  }
  const arr = r.data || [];
  const tbody = document.querySelector("#scan tbody");
  tbody.innerHTML = (arr || []).map(s => {
    const reasonShort = (s.reasons && s.reasons.length) ? s.reasons.slice(0,2).join(", ") : (s.reason || "‚Äî");
    return `<tr data-symbol="${s.symbol}">
      <td><a class="symbol-link" data-symbol="${s.symbol}">${s.symbol}</a></td>
      <td>${s.score ?? "-"}</td>
      <td>${s.entry? Number(s.entry).toFixed(6) : "-"}</td>
      <td>${s.tp? Number(s.tp).toFixed(6) : "-"}</td>
      <td>${reasonShort}</td>
      <td><button class="buy-btn btn-small" data-symbol="${s.symbol}">Buy</button></td>
    </tr>`;
  }).join("") || "<tr><td colspan='6'>No signals</td></tr>";
  log("Scan results updated: " + (arr||[]).length);
}

// buy action
async function manualBuy(symbol) {
  if(!confirm("Place manual BUY on " + symbol + " ?")) return;
  const r = await safeFetch(API_BASE + "/bitget/order", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ symbol, side: "buy" }) });
  if (r.ok) {
    log("Buy placed: " + (r.data?.trade?.id || JSON.stringify(r.data)));
    loadTrades(); loadBalance(); loadScan();
  } else {
    alert("Buy failed: " + (r.text || r.error || "see logs"));
    log("Buy failed: " + (r.text || r.error || "unknown"));
  }
}

// close trade
async function closeTrade(tradeId) {
  if(!confirm("Close (sell) trade " + tradeId + " ?")) return;
  const r = await safeFetch(API_BASE + "/trade/close", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ trade_id: tradeId }) });
  if (r.ok) {
    log("Trade closed: " + tradeId);
    loadTrades(); loadBalance(); loadScan();
  } else {
    alert("Close failed: " + (r.text || r.error || "see logs"));
  }
}

// load trades
async function loadTrades(){
  const r = await safeFetch(API_BASE + "/trades");
  if (!r.ok) { document.getElementById("tradelist").innerHTML = "No trades"; return; }
  const arr = r.data || [];
  const node = document.getElementById("tradelist");
  if (!arr.length) { node.innerHTML = "No trades"; return; }
  node.innerHTML = arr.slice().reverse().map(t => {
    if (t.status === "OPEN") {
      return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <strong>${t.symbol}</strong> | ${t.side} | qty:${t.qty} | entry:${t.entry_price || '-'} | invested:${t.invested || '-'} | buy_fee:${t.buy_fee || '-'}
        <div>latest:${t.latest_price || 'n/a'} | est_net:${t.est_net || 'n/a'} | unreal_pnl:${t.unreal_pnl ?? 0}</div>
        <div style="margin-top:6px"><button class="close-btn btn-small" data-trade="${t.id}">Close (Sell)</button></div>
      </div>`;
    } else {
      return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${t.symbol}</strong> | ${t.side} | status:${t.status} | pnl:${t.pnl || 0} | invested:${t.invested} | closed:${t.closed_at}</div>`;
    }
  }).join("");
}

// load balance
async function loadBalance(){
  const r = await safeFetch(API_BASE + "/bitget/balance");
  const el = document.getElementById("balance");
  if (!r.ok) { el.innerText = "Balance: n/a"; return; }
  const b = r.data["USDT"] || r.data["usdt"] || r.data.USDT || "n/a";
  el.innerText = "USDT Balance: " + b;
}

// indicator modal
async function showIndicators(symbol) {
  const res = await safeFetch(API_BASE + "/scan/results");
  if (!res.ok) return alert("Cannot fetch scan results");
  const s = (res.data || []).find(x => x.symbol === symbol);
  if (!s) return alert("No indicator snapshot for " + symbol);
  const content = [];
  content.push(`<h3>${symbol} ‚Äî score ${s.score ?? "-"}</h3>`);
  content.push(`<div class="indicator-list"><b>Entry:</b> ${s.entry ?? "-"} &nbsp; <b>TP:</b> ${s.tp ?? "-"}</div>`);
  content.push(`<div class="indicator-list"><b>Reasons:</b> ${(s.reasons && s.reasons.length) ? s.reasons.join(", ") : (s.reason || "‚Äî")}</div>`);
  content.push("<hr>");
  content.push("<div class='indicator-list'><pre style='white-space:pre-wrap;'>" + JSON.stringify(s.indicators || {}, null, 2) + "</pre></div>");
  document.getElementById("modalContent").innerHTML = content.join("");
  document.getElementById("modal").style.display = "block";
}

// event delegation
document.addEventListener("click", (ev) => {
  const t = ev.target;
  if (t.matches("a.symbol-link")) {
    const symbol = t.dataset.symbol;
    showIndicators(symbol);
    ev.preventDefault();
    return;
  }
  if (t.matches("button.buy-btn")) {
    manualBuy(t.dataset.symbol);
    return;
  }
  if (t.matches("button.close-btn")) {
    closeTrade(t.dataset.trade);
    return;
  }
});

// controls
document.getElementById("deepScan").addEventListener("click", async () => {
  log("Triggering deep scan (may take 1-2 minutes)...");
  const r = await safeFetch(API_BASE + "/scan/run", { method: "POST" });
  if (r.ok) { log("Deep scan complete: " + (r.data.length || 0)); loadScan(); }
});
let autoOn = false;
document.getElementById("toggleAuto").addEventListener("click", async () => {
  autoOn = !autoOn;
  document.getElementById("toggleAuto").innerText = autoOn ? "‚è± Auto: ON" : "‚è± Auto: OFF";
  await safeFetch(API_BASE + "/auto/set", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ enabled: autoOn }) });
  log("Auto set: " + autoOn);
});
document.getElementById("refreshAll").addEventListener("click", () => { loadScan(); loadBalance(); loadTrades(); });
document.getElementById("showTrades").addEventListener("click", () => loadTrades());
document.getElementById("closeModal").addEventListener("click", () => document.getElementById("modal").style.display = "none");

// initial load
(async function init(){
  await updateStatus();
  await loadScan(); await loadBalance(); await loadTrades();
  setInterval(updateStatus, 60*1000);
  setInterval(loadScan, 60*1000);
  setInterval(loadTrades, 30*1000);
})();
</script>
</body>
</html>
