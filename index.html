<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>DexScan - Bitget Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{background:#071020;color:#e6f0f0;font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#071526;border-radius:8px}
    h1{margin:0;font-size:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card{background:#0e1720;padding:12px;border-radius:8px;flex:1;min-width:260px}
    button{background:#2a9d8f;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .green{color:#4ade80}.red{color:#fb7185}
    .small{font-size:13px;color:#9fb0b9}
    #logs{max-height:200px;overflow:auto;background:#071526;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>üíπ DexScan ‚Äî Bitget Dashboard</h1>
    <div id="status" class="small">Connecting...</div>
  </header>

  <div class="row">
    <div class="card">
      <h3>Controls</h3>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="deepScan">üîç Deep Scan</button>
        <button id="toggleAuto">‚è± Auto: OFF</button>
        <button id="refreshAll">üîÑ Refresh</button>
      </div>
      <div style="margin-top:8px" class="small">Demo mode: controlled by backend env BITGET_DEMO. Do not enable live until tested.</div>
      <div style="margin-top:8px" id="logs" class="small"></div>
    </div>

    <div class="card">
      <h3>Top 10</h3>
      <table id="top10">
        <thead><tr><th>Symbol</th><th>Price</th><th>24h</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Scanner Results</h3>
      <table id="scan">
        <thead><tr><th>Symbol</th><th>Score</th><th>Entry</th><th>TP</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Trades & Wallet</h3>
      <div id="balance" class="small">Balance: ...</div>
      <div style="margin-top:8px">
        <button id="showTrades">Show Trades</button>
      </div>
      <div id="tradelist" style="margin-top:8px"></div>
    </div>
  </div>

<script>
const API_BASE = location.protocol + '//' + location.host + '/api';

function log(msg){
  const node = document.getElementById("logs");
  node.innerHTML = new Date().toLocaleTimeString() + " ‚Äî " + msg + "<br>" + node.innerHTML;
}

// load top10
async function loadTop10(){
  try {
    const r = await fetch(API_BASE + "/top10");
    const arr = await r.json();
    const tbody = document.querySelector("#top10 tbody");
    tbody.innerHTML = arr.map(a => `<tr>
      <td>${a.symbol}</td>
      <td>${Number(a.price).toLocaleString()}</td>
      <td class="${String(a.change24h).startsWith('-') ? 'red' : 'green'}">${a.change24h}%</td>
      </tr>`).join("");
    log("Top10 refreshed");
  } catch(e){ log("Top10 load error"); }
}

// load scan
async function loadScan() {
  try {
    const r = await fetch(API_BASE + "/scan/results");
    const arr = await r.json();
    const tbody = document.querySelector("#scan tbody");
    tbody.innerHTML = (arr || []).map(s => `<tr>
      <td>${s.symbol}</td>
      <td>${s.score}</td>
      <td>${Number(s.entry).toFixed(6)}</td>
      <td>${Number(s.tp).toFixed(6)}</td>
      <td>
        <button onclick="manualBuy('${s.symbol}')">Buy</button>
      </td>
    </tr>`).join("");
    log("Scan results loaded");
  } catch(e){ log("Scan load error"); }
}

// manual buy
async function manualBuy(symbol){
  try {
    if(!confirm("Place manual BUY on " + symbol + " ?")) return;
    const body = { symbol, side: "buy" }; // percent uses default PERCENT_PER_TRADE
    const r = await fetch(API_BASE + "/bitget/order", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
    const j = await r.json();
    log("Manual buy response: " + JSON.stringify(j));
    loadTrades();
    loadBalance();
  } catch(e){ log("Buy error: " + e.message); }
}

// load trades
async function loadTrades(){
  try {
    const r = await fetch(API_BASE + "/trades");
    const arr = await r.json();
    const node = document.getElementById("tradelist");
    if(!arr || arr.length===0){ node.innerHTML = "No trades"; return; }
    node.innerHTML = arr.slice().reverse().map(t => `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">
      ${t.id} | ${t.symbol} | ${t.side} | qty:${t.qty} | price:${t.price} | ${t.placed_at}</div>`).join("");
  } catch(e){ log("Trades load error"); }
}

// load balance
async function loadBalance(){
  try {
    const r = await fetch(API_BASE + "/bitget/balance");
    const j = await r.json();
    if(j && typeof j === 'object') {
      const b = j["USDT"] || j["usdt"] || j.USDT || (j.data && j.data.USDT) || "n/a";
      document.getElementById("balance").innerText = "USDT Balance: " + b;
    } else {
      document.getElementById("balance").innerText = "Balance: " + JSON.stringify(j);
    }
  } catch(e){ log("Balance load error"); }
}

// deep scan
document.getElementById("deepScan").addEventListener("click", async () => {
  try {
    log("Triggering deep scan (this may take 1-2 minutes)...");
    const r = await fetch(API_BASE + "/scan/run", { method: "POST" });
    const j = await r.json();
    log("Deep scan complete: " + (j.length || 0) + " results");
    loadScan();
  } catch(e){ log("Scan trigger error"); }
});

// auto toggle
let autoOn = false;
document.getElementById("toggleAuto").addEventListener("click", async () => {
  try {
    autoOn = !autoOn;
    document.getElementById("toggleAuto").innerText = autoOn ? "‚è± Auto: ON" : "‚è± Auto: OFF";
    await fetch(API_BASE + "/auto/set", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ enabled: autoOn })});
    log("Auto toggled: " + autoOn);
  } catch(e){ log("Auto toggle error"); }
});

// refresh
document.getElementById("refreshAll").addEventListener("click", () => { loadTop10(); loadScan(); loadBalance(); loadTrades(); });

// show trades
document.getElementById("showTrades").addEventListener("click", () => loadTrades());

// initial load
loadTop10();
loadScan();
loadBalance();
loadTrades();
setInterval(loadTop10, 20000);
setInterval(loadScan, 60000);
</script>
</body>
</html>
