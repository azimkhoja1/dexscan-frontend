<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>DexScan ‚Äî Bitget Dashboard (Reference UI)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b1220; --card:#0e1720; --muted:#7b8b95; --accent:#17a589; --danger:#e74c3c; --win:#16a34a;
      --panel-radius:10px; --pad:14px; --font:Inter,Segoe UI,Arial,sans-serif;
    }
    body{margin:0;font-family:var(--font);background:linear-gradient(180deg,#041024, #071020);color:#e6f0f0}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:transparent}
    h1{font-size:18px;margin:0}
    .top-live{display:flex;gap:18px;align-items:center}
    .live-item{font-size:14px;color:#cfe8e0}
    .container{display:flex;gap:18px;padding:18px}
    .left{width:360px}
    .card{background:var(--card);border-radius:var(--panel-radius);padding:var(--pad);box-shadow:0 6px 20px rgba(2,6,10,0.6)}
    .controls .actions{display:flex;gap:8px;margin-top:8px}
    button{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#2a3b46}
    .small{font-size:13px;color:var(--muted)}
    #logs{height:240px;overflow:auto;margin-top:12px;background:#071526;padding:8px;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;vertical-align:middle}
    th{color:#9fb0b9;font-size:13px}
    .name-col{display:flex;align-items:center;gap:10px}
    .symbol{font-weight:600;color:#bfeee2;cursor:default}
    .status-pill{background:#0d2a24;color:#7ee6cc;padding:4px 8px;border-radius:999px;font-size:12px}
    .sell-now{background:var(--danger);padding:8px 12px;border-radius:8px;color:white;border:none;cursor:pointer}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .toggle input{width:40px;height:22px;appearance:none;background:#223239;border-radius:999px;position:relative;outline:none}
    .toggle input:checked{background:#17a589}
    .toggle input::after{content:'';width:18px;height:18px;background:white;border-radius:50%;position:relative;left:2px;top:2px;display:block;transition:all .15s}
    .toggle input:checked::after{transform:translateX(18px)}
    .tooltip{position:absolute;background:#071526;padding:10px;border-radius:8px;color:#cfe8e0;box-shadow:0 6px 20px rgba(0,0,0,0.5);display:none;z-index:9999}
    .settings-row{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .input{background:#071526;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:6px;color:#cfe8e0}
    .muted{color:var(--muted);font-size:13px}
    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    .table-wrap{overflow:auto}
    .actions-col{display:flex;gap:8px;align-items:center}
    .badge{background:#112233;padding:4px 6px;border-radius:6px;color:#9fb0b9;font-size:12px}
    .right{width:360px}
    .settings-panel{position:fixed;left:0;top:0;height:100%;width:320px;background:#071526;padding:18px;box-shadow:2px 0 20px rgba(0,0,0,0.6);transform:translateX(-340px);transition:transform .22s}
    .settings-panel.open{transform:translateX(0)}
    .save-btn{background:#f6c23e;color:#08121c;border:none;padding:10px;border-radius:8px;width:100%;cursor:pointer;margin-top:12px}
    .col-2{display:flex;gap:8px}
    .hoverable{position:relative}
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:16px">
    <h1>DexScan ‚Äî Bitget UX</h1>
    <div class="top-live">
      <div class="live-item">BTC <span id="btcTop">‚Äî</span></div>
      <div class="live-item">ETH <span id="ethTop">‚Äî</span></div>
      <div class="live-item">BNB <span id="bnbTop">‚Äî</span></div>
    </div>
  </div>
  <div id="backendStatus" class="small">Backend not reachable</div>
</header>

<div class="container">
  <!-- LEFT CONTROLS -->
  <div class="left">
    <div class="card controls">
      <h3>Controls</h3>
      <div class="actions">
        <button id="deepScan">üîç Deep Scan</button>
        <button id="autoToggle" class="secondary">‚è± Auto: OFF</button>
        <button id="refreshBtn" class="secondary">üîÑ Refresh</button>
        <button id="openSettings" class="secondary">‚öôÔ∏è Settings</button>
      </div>
      <div class="small muted" style="margin-top:10px">
        Demo mode controlled by backend. Live trading requires BITGET_DEMO=0 and live keys.
      </div>

      <div id="logs" class="small"></div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="card table-wrap">
      <h3 style="margin:0 0 6px 0">Scanner / Active Positions</h3>
      <table id="mainTable">
        <thead>
          <tr>
            <th>NAME</th><th>STATUS</th><th>ENTRY</th><th>PRICE</th><th>P&L</th><th>SELL SIGNAL</th><th>VALUE</th><th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- rows injected -->
        </tbody>
      </table>
    </div>
    <div style="display:flex;gap:12px">
      <div class="card" style="flex:1">
        <h4>Scanner Results (signals)</h4>
        <div id="signalsList" class="small muted">No signals yet</div>
      </div>
      <div class="card" style="width:300px">
        <h4>Quick Actions</h4>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="buyAllBtn">Auto Buy Top N</button>
          <button id="sellAllBtn" class="secondary">Close All (Sell)</button>
          <div class="muted small">Auto Buy respects settings (Invest / Count / TP). Use with care.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="card">
      <h4>Trades & Wallet</h4>
      <div id="balanceTop" class="small">USDT: ...</div>
      <div style="margin-top:10px">
        <button id="showTrades">Show Trades</button>
      </div>
      <div id="tradesDiv" style="margin-top:10px" class="small muted">No trades</div>
    </div>
  </div>
</div>

<!-- tooltip -->
<div id="tooltip" class="tooltip"></div>

<!-- settings panel -->
<div id="settingsPanel" class="settings-panel">
  <h3>Settings</h3>
  <div class="settings-row">
    <label class="small">Take Profit %</label>
    <input id="setting_tp" class="input" type="number" value="10">
    <label class="small">Stop Loss % (0 = disabled)</label>
    <input id="setting_sl" class="input" type="number" value="100">
    <label class="small">Investment Amount (USD)</label>
    <input id="setting_invest" class="input" type="number" value="5">
    <label class="small">Number of Coins to Buy (concurrent)</label>
    <input id="setting_count" class="input" type="number" value="10">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">Auto Sell</div>
      <label class="toggle"><input id="setting_autosell" type="checkbox"></label>
    </div>
    <button id="saveSettings" class="save-btn">Save Settings</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://dexscan-backend.onrender.com/api";
const tooltip = document.getElementById("tooltip");

/* ---------- UTIL ---------- */
function log(msg){
  const node = document.getElementById("logs");
  node.innerHTML = new Date().toLocaleTimeString() + " ‚Äî " + msg + "<br>" + node.innerHTML;
  console.log(msg);
}
async function sfetch(path, opts = {}) {
  try {
    const r = await fetch(API_BASE + path, opts);
    if (!r.ok) {
      const txt = await r.text();
      log(`HTTP ${r.status} ${path} ‚Äî ${txt}`);
      return { ok:false, status:r.status, text:txt };
    }
    const j = await r.json();
    return { ok:true, data:j };
  } catch (e) {
    log("Fetch error: " + e.message);
    return { ok:false, error:e.message };
  }
}

/* ---------- LIVE TOP PAIR WS (frontend) ---------- */
function wsPair(sym, elId){
  try {
    const s = sym.toLowerCase();
    const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${s}@trade`);
    ws.onmessage = ev => {
      try {
        const d = JSON.parse(ev.data);
        document.getElementById(elId).innerText = Number(d.p).toLocaleString();
      } catch(e){}
    };
    ws.onopen = () => console.log("WS ok", sym);
  } catch(e){console.warn(e)}
}
wsPair("BTCUSDT","btcTop");
wsPair("ETHUSDT","ethTop");
wsPair("BNBUSDT","bnbTop");

/* ---------- UI: show rows ---------- */

async function renderTable(){
  // Read current trades
  const tresp = await sfetch("/trades");
  const trades = (tresp.ok && Array.isArray(tresp.data)) ? tresp.data : [];
  // Read scan results
  const sresp = await sfetch("/scan/results");
  const signals = (sresp.ok && Array.isArray(sresp.data)) ? sresp.data : [];
  // Build rows: first active trades, then signals not in trades
  const openSymbols = (trades||[]).filter(t=>t.status==="OPEN").map(t=>t.symbol);
  const rows = [];
  // Active trades rows
  for (const t of trades.filter(x=>x.status==="OPEN")){
    rows.push({
      name: t.symbol,
      status: "active",
      entry: t.entry_price || t.entry || "-",
      price: t.latest_price || "-",
      pnl: t.unreal_pnl ?? t.pnl ?? 0,
      signal: "HOLD",
      value: t.invested || 0,
      trade: t
    });
  }
  // signals rows (up to 10) (skip if already bought open)
  for (const s of signals.slice(0, 10)) {
    if (openSymbols.includes(s.symbol)) continue;
    rows.push({
      name: s.symbol,
      status: "signal",
      entry: s.entry,
      price: s.entry,
      pnl: 0,
      signal: (s.reasons && s.reasons.length) ? s.reasons.join("; ") : "signal",
      value: 0,
      signalObj: s
    });
  }

  // render
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = rows.map(r => {
    const pnlClass = (r.pnl>0) ? 'green' : (r.pnl<0 ? 'red' : '');
    const actions = r.trade ? 
      `<div class="actions-col"><label class="toggle"><input type="checkbox" data-trade="${r.trade.id}" class="autosell-toggle" ${r.trade.autoSell ? 'checked': ''}></label><button class="sell-now" data-sell="${r.trade.id}">Sell Now</button></div>`
      : `<div class="actions-col"><button class="buy-now" data-symbol="${r.name}">Buy</button></div>`;
    // value formatting
    return `<tr class="hoverable" data-symbol="${r.name}">
      <td><div class="name-col"><div class="symbol" data-symbol="${r.name}">${r.name}</div></div></td>
      <td>${r.status === "active" ? '<span class="status-pill">active</span>' : '<span class="badge">signal</span>'}</td>
      <td>${r.entry ? Number(r.entry).toFixed(6) : '-'}</td>
      <td>${r.price ? Number(r.price).toLocaleString() : '-'}</td>
      <td class="${pnlClass}">${r.pnl??0}</td>
      <td>${r.signal}</td>
      <td>$${Number(r.value||0).toFixed(2)}</td>
      <td>${actions}</td>
    </tr>`;
  }).join("");
  attachRowListeners();
  // also populate signals list small panel
  document.getElementById("signalsList").innerText = signals.length ? signals.map(s=>s.symbol+" ("+s.score+")").join(", ") : "No signals";
}

/* ---------- attach events on rows ---------- */
function attachRowListeners(){
  // buy buttons
  document.querySelectorAll(".buy-now").forEach(btn=>{
    btn.onclick = async (e) => {
      const sym = btn.dataset.symbol;
      if (!confirm("Place demo BUY on " + sym + " ?")) return;
      log("Placing buy " + sym);
      const res = await sfetch("/bitget/order", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ symbol: sym, side: "buy" })});
      if (res.ok) { log("Buy order placed"); await renderTable(); await loadTrades(); await loadBalance(); }
      else alert("Buy failed: " + (res.text || res.error || JSON.stringify(res.data)));
    };
  });
  // sell now buttons
  document.querySelectorAll(".sell-now").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.dataset.sell;
      if (!confirm("Sell trade " + id + " now?")) return;
      const res = await sfetch("/trade/close", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ trade_id: id })});
      if (res.ok) { log("Sold: " + id); await renderTable(); await loadTrades(); await loadBalance(); }
      else alert("Sell failed: " + (res.text || res.error));
    };
  });
  // autosell toggles
  document.querySelectorAll(".autosell-toggle").forEach(input=>{
    input.onchange = async () => {
      const id = input.dataset.trade;
      const val = input.checked;
      const res = await sfetch("/trade/toggle_autosell", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ trade_id: id, auto: val })});
      if (res.ok) log("AutoSell set for "+id+" => "+val);
      else { log("AutoSell toggle failed"); input.checked = !val; }
    };
  });
  // hover tooltip on symbol: show reasons by fetching /scan/results and match symbol
  document.querySelectorAll(".symbol").forEach(el=>{
    el.onmouseenter = async (ev) => {
      const sym = el.dataset.symbol;
      // fetch scan results to get reasons
      const res = await sfetch("/scan/results");
      if (!res.ok) return;
      const s = (res.data||[]).find(x => x.symbol === sym) || null;
      let html = `<strong>${sym}</strong><br/>`;
      if (s) {
        html += `Score: ${s.score}<br/>Reasons: ${(s.reasons || []).slice(0,4).join(", ")}<br/>Entry: ${s.entry}<br/>TP: ${s.tp}`;
      } else html += "No detailed reason (maybe already bought or not scanned)";
      tooltip.innerHTML = html;
      tooltip.style.display = "block";
      const r = el.getBoundingClientRect();
      tooltip.style.left = (r.right + 12) + "px";
      tooltip.style.top = (r.top) + "px";
    };
    el.onmouseleave = () => { tooltip.style.display = "none"; tooltip.innerHTML = ""; };
  });
}

/* ---------- Trades list and balance ---------- */
async function loadTrades(){
  const r = await sfetch("/trades");
  if (!r.ok) { document.getElementById("tradesDiv").innerText = "No trades"; return; }
  const arr = r.data || [];
  const html = arr.slice().reverse().map(t=>{
    if (t.status === "OPEN") return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${t.symbol}</strong> - invested ${t.invested} | entry ${t.entry_price} | <button class="sell-now" data-sell="${t.id}">Sell</button></div>`;
    else return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${t.symbol}</strong> - CLOSED pnl:${t.pnl}</div>`;
  }).join("");
  document.getElementById("tradesDiv").innerHTML = html || "No trades";
}

async function loadBalance(){
  const r = await sfetch("/bitget/balance");
  if (!r.ok) { document.getElementById("balanceTop").innerText = "USDT: n/a"; return; }
  const val = r.data.USDT || r.data.usdt || r.data.USDT || r.data.USDT;
  document.getElementById("balanceTop").innerText = "USDT: " + (val ?? "n/a");
}

/* ---------- SETTINGS panel ---------- */
const panel = document.getElementById("settingsPanel");
document.getElementById("openSettings").onclick = async () => {
  // load server settings
  const r = await sfetch("/settings");
  if (r.ok) {
    const s = r.data || {};
    document.getElementById("setting_tp").value = s.tp ?? 10;
    document.getElementById("setting_sl").value = s.sl ?? 100;
    document.getElementById("setting_invest").value = s.invest ?? 5;
    document.getElementById("setting_count").value = s.count ?? 10;
    document.getElementById("setting_autosell").checked = !!s.autosell;
  }
  panel.classList.add("open");
};
document.getElementById("saveSettings").onclick = async () => {
  const s = {
    tp: Number(document.getElementById("setting_tp").value || 10),
    sl: Number(document.getElementById("setting_sl").value || 100),
    invest: Number(document.getElementById("setting_invest").value || 5),
    count: Number(document.getElementById("setting_count").value || 10),
    autosell: !!document.getElementById("setting_autosell").checked
  };
  const res = await sfetch("/settings", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(s) });
  if (res.ok) { log("Settings saved"); panel.classList.remove("open"); }
  else alert("Failed save");
};

/* CLICK OUTSIDE TO CLOSE PANEL */
document.addEventListener("click", function(e){
  if (!panel.contains(e.target) && !document.getElementById("openSettings").contains(e.target)) panel.classList.remove("open");
});

/* ---------- Extra actions ---------- */
document.getElementById("deepScan").onclick = async () => {
  log("Trigger deep scan...");
  const r = await sfetch("/scan/run", { method:"POST" });
  if (r.ok) log("Scan finished: " + (r.data?.length||0));
  await renderTable();
};
document.getElementById("refreshBtn").onclick = async () => { await renderTable(); await loadTrades(); await loadBalance(); };
document.getElementById("showTrades").onclick = loadTrades;
document.getElementById("buyAllBtn").onclick = async () => {
  if (!confirm("Auto-buy top N signals?")) return;
  // call backend /auto/set true -> worker will buy; or we can loop and call /bitget/order for top signals
  const r = await sfetch("/auto/set", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ enabled:true })});
  if (r.ok) document.getElementById("autoToggle").innerText = "‚è± Auto: ON";
  log("Auto buy started by worker");
};
document.getElementById("sellAllBtn").onclick = async () => {
  if (!confirm("Close all open trades?")) return;
  const tradesResp = await sfetch("/trades");
  if (!tradesResp.ok) return alert("Cannot list trades");
  const open = (tradesResp.data||[]).filter(t=>t.status==="OPEN");
  for (const t of open) {
    await sfetch("/trade/close", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ trade_id: t.id })});
    log("Requested close " + t.id);
  }
  await loadTrades(); await renderTable();
};

/* ---------- auto toggle button ---------- */
document.getElementById("autoToggle").onclick = async () => {
  const cur = document.getElementById("autoToggle").innerText.includes("ON");
  const enable = !cur;
  const r = await sfetch("/auto/set", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ enabled: enable })});
  if (r.ok) {
    document.getElementById("autoToggle").innerText = enable ? "‚è± Auto: ON" : "‚è± Auto: OFF";
    log("Auto toggled: " + enable);
  } else log("Auto toggle failed");
};

/* ---------- toggle backend status ---------- */
async function updateBackendStatus(){
  const r = await sfetch("/");
  const st = document.getElementById("backendStatus");
  if (r.ok) st.innerText = "Backend connected";
  else st.innerText = "Backend not reachable";
}

/* ---------- init ---------- */
(async function init(){
  await updateBackendStatus();
  await renderTable();
  await loadTrades();
  await loadBalance();
  setInterval(loadBalance, 30000);
  setInterval(renderTable, 60000);
})();
</script>
</body>
</html>
