<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DexScan V3.5 — Bitget Bot</title>
  <link rel="icon" href="data:,">
  <style>
    :root {
      --bg: #071226;
      --card: #0f2430;
      --muted: #9fb0b9;
      --accent: #16a085;
      --danger: #e74c3c;
    }
    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      background: linear-gradient(180deg, #041024, #071020);
      color: #e6f0f0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
    }
    .card {
      background: var(--card);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .center {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .login-card {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 0;
    }
    button {
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .btn { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 8px 10px; cursor: pointer; }
    .btn.gray { background: #22343a; }
    .btn.red { background: var(--danger); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      text-align: left;
    }
    th { color: var(--muted); font-size: 12px; }
    #log { height: 120px; overflow: auto; background: #071526; padding: 8px; border-radius: 6px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="app"></div>

<script>
/* ===== CONFIG ===== */
const BACKEND_ROOT = "https://dexscan-backend.onrender.com";
const API = BACKEND_ROOT + "/api";
const PRICE_FEED = "https://api.bitget.com/api/v2/market/tickers?symbol=";

/* ===== AUTH ===== */
function setToken(t){localStorage.setItem("dex_token", t);}
function getToken(){return localStorage.getItem("dex_token");}
function clearToken(){localStorage.removeItem("dex_token");}

/* ===== DOM ===== */
const app = document.getElementById("app");

/* ===== LOGIN ===== */
function htmlLogin(){
  app.innerHTML = `
    <div class="center">
      <div class="login-card">
        <h2 style="margin:0 0 6px 0">DexScan Login</h2>
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
        <div style="font-size:13px;color:#9fb0b9;margin-top:8px">
          Demo user: dailybuy / dailyprofitinshallah!@#
        </div>
      </div>
    </div>`;
  document.getElementById("loginBtn").onclick = async () => {
    const u = username.value.trim(), p = password.value.trim();
    if(!u||!p) return alert("Enter username & password");
    try {
      const r = await fetch(API+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
      const j = await r.json();
      if(r.ok&&j.ok){setToken(j.token);renderApp();}
      else alert("Login failed: "+(j.error||"invalid"));
    }catch(e){alert("Network error: "+e.message);}
  };
}

/* ===== DASHBOARD ===== */
function htmlApp(){
  app.innerHTML = `
    <header>
      <div style="display:flex;gap:10px;align-items:center">
        <h3 style="margin:0">DexScan V3.5</h3>
        <div id="topPrices" style="font-size:13px;color:#9fb0b9">BTC: -- | ETH: -- | BNB: --</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div id="modeLabel" style="font-size:13px;color:#9fb0b9">
          Mode: <b id="modeText">Loading...</b>
        </div>
        <button id="logout" class="btn gray">Logout</button>
      </div>
    </header>

    <div style="display:flex;gap:12px;padding:12px">
      <div style="width:320px">
        <div class="card">
          <h4 style="margin:0 0 8px 0">Controls</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="deepScan" class="btn">Deep Scan</button>
            <button id="autoToggle" class="btn gray">Auto: OFF</button>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="modeToggle" class="btn">Switch Mode</button>
            <button id="refreshBtn" class="btn gray">Refresh</button>
          </div>
          <div id="log" style="font-size:12px"></div>
        </div>
      </div>

      <div style="flex:1;display:flex;flex-direction:column;gap:12px">
        <div class="card">
          <h4 style="margin:0 0 8px 0">Scanner Results</h4>
          <table>
            <thead><tr><th>Symbol</th><th>Score</th><th>Entry</th><th>Reasons</th><th>Action</th></tr></thead>
            <tbody id="scanBody"></tbody>
          </table>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Trades & Wallet</h4>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>Balance: <b id="balance">-</b></div>
            <div>
              <select id="showFilter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
          </div>
          <table>
            <thead><tr><th>Symbol</th><th>Entry</th><th>Latest</th><th>PNL</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="tradesBody"></tbody>
          </table>
        </div>
      </div>
    </div>`;
  logout.onclick=()=>{clearToken();renderApp();};
  deepScan.onclick=deepScan;
  refreshBtn.onclick=refreshAll;
  autoToggle.onclick=toggleAuto;
  modeToggle.onclick=toggleMode;
  showFilter.onchange=loadTrades;
}

/* ===== API HELPERS ===== */
function authHeaders(){const t=getToken();return t?{"Authorization":"Bearer "+t,"Content-Type":"application/json"}:{"Content-Type":"application/json"};}
async function apiGet(p){try{const r=await fetch(API+p,{headers:authHeaders()});if(r.status===401){clearToken();renderApp();return null;}return await r.json();}catch(e){appendLog("Network error: "+e.message);return null;}}
async function apiPost(p,b){try{const r=await fetch(API+p,{method:"POST",headers:authHeaders(),body:JSON.stringify(b||{})});if(r.status===401){clearToken();renderApp();return null;}return await r.json();}catch(e){appendLog("Network error: "+e.message);return null;}}

/* ===== LOGGING ===== */
function appendLog(msg){const el=document.getElementById("log");if(!el)return;el.innerHTML=new Date().toLocaleTimeString()+" — "+msg+"<br>"+el.innerHTML;}

/* ===== FUNCTIONS ===== */
async function refreshTop(){
  try{
    const res=await fetch(PRICE_FEED+"BTCUSDT,ETHUSDT,BNBUSDT");
    const j=await res.json();
    const tickers=j.data||[];
    const btc=tickers.find(x=>x.symbol==="BTCUSDT")?.lastPr??0;
    const eth=tickers.find(x=>x.symbol==="ETHUSDT")?.lastPr??0;
    const bnb=tickers.find(x=>x.symbol==="BNBUSDT")?.lastPr??0;
    document.getElementById("topPrices").innerText=`BTC: ${btc} | ETH: ${eth} | BNB: ${bnb}`;
  }catch(e){console.log("Top price error",e);}
}

async function deepScan(){
  appendLog("Deep scan started...");
  const r=await apiPost("/scan/run",{});
  if(Array.isArray(r)){renderScan(r);appendLog("Deep scan finished — found "+r.length);}else appendLog("Scan failed");
}

function renderScan(list){
  const tbody=document.getElementById("scanBody");tbody.innerHTML="";
  (list||[]).forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${it.symbol}</td>
      <td>${it.score}</td>
      <td>${it.entry?.toFixed?.(6)||"-"}</td>
      <td>${(it.reasons||[]).slice(0,3).join(", ")}</td>
      <td><button class="btn" onclick="buySymbol('${it.symbol}')">Buy</button></td>`;
    tbody.appendChild(tr);
  });
}

async function buySymbol(sym){
  appendLog("Buy requested "+sym);
  const r=await apiPost("/trade/buy",{symbol:sym});
  appendLog(r&&r.ok?"Buy success "+sym:"Buy error");
  await loadTrades();await loadBalance();
}

async function loadTrades(){
  const data=await apiGet("/trades");
  if(!data)return;
  const filter=showFilter.value;
  const tbody=document.getElementById("tradesBody");
  tbody.innerHTML="";
  for(const t of data){
    if(filter==="open"&&t.status!=="OPEN")continue;
    if(filter==="closed"&&t.status==="OPEN")continue;
    const pnl=t.unreal_pnl??t.pnl??0;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${t.symbol}</td>
      <td>${t.entry_price?.toFixed?.(6)||"-"}</td>
      <td id="latest-${t.symbol}">${t.latest_price?.toFixed?.(6)||"-"}</td>
      <td id="pnl-${t.symbol}" style="color:${pnl>=0?'#7ee787':'#ff6b6b'}">${Number(pnl).toFixed(4)}</td>
      <td>${t.status}</td>
      <td>${t.status==="OPEN"?'<button class="btn red" onclick="closeTrade(\''+t.id+'\')">Sell</button>':'-'}</td>`;
    tbody.appendChild(tr);
  }
}

async function updateLivePNL(){
  const tbody=document.getElementById("tradesBody");
  const rows=[...tbody.querySelectorAll("tr")];
  if(!rows.length)return;
  for(const row of rows){
    const symbol=row.children[0].innerText;
    try{
      const res=await fetch(PRICE_FEED+symbol);
      const j=await res.json();
      const p=j.data?.[0]?.lastPr;
      if(p){
        const latest=document.getElementById(`latest-${symbol}`);
        if(latest)latest.innerText=Number(p).toFixed(6);
        const entry=parseFloat(row.children[1].innerText)||0;
        const pnl=((p-entry)/entry*100)||0;
        const pnlEl=document.getElementById(`pnl-${symbol}`);
        if(pnlEl){pnlEl.innerText=pnl.toFixed(2)+"%";pnlEl.style.color=pnl>=0?'#7ee787':'#ff6b6b';}
      }
    }catch(e){console.log("PNL error",symbol,e);}
  }
}

async function closeTrade(id){
  appendLog("Close requested "+id);
  const r=await apiPost("/trade/sell",{trade_id:id});
  appendLog(r&&r.ok?"Closed "+id:"Close error");
  await loadTrades();await loadBalance();
}

async function loadBalance(){
  const b=await apiGet("/balance");
  if(!b)return;
  document.getElementById("balance").innerText=(b.balance?.USDT??0).toFixed(2);
}

async function toggleAuto(){
  const cur=await apiGet("/auto");
  const next=!cur?.auto;
  await apiPost("/auto",{enabled:next});
  autoToggle.innerText=next?"Auto: ON":"Auto: OFF";
  appendLog("Auto set -> "+next);
}

async function toggleMode(){
  const cur=await apiGet("/mode");
  const next=!cur?.demo;
  await apiPost("/mode",{demo:next});
  modeText.innerText=next?"Demo":"Live";
  appendLog("Mode set -> "+(next?"Demo":"Live"));
}

async function refreshAll(){
  await refreshTop();await loadBalance();await loadTrades();
}

/* ===== MAIN ===== */
async function renderApp(){
  const t=getToken();
  if(!t){htmlLogin();return;}
  htmlApp();
  await refreshAll();
  const m=await apiGet("/mode");
  modeText.innerText=m?.demo?"Demo":"Live";
  const auto=await apiGet("/auto");
  if(auto&&auto.auto){appendLog("Auto active — running deep scan...");deepScan();autoToggle.innerText="Auto: ON";}
  setInterval(refreshTop,5000);
  setInterval(loadTrades,7000);
  setInterval(updateLivePNL,5000);
  setInterval(loadBalance,10000);
}

/* Boot */
renderApp();
</script>
</body>
</html>
